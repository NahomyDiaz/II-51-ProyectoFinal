<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UNICONNECT - Registro</title>
    <link rel="stylesheet" href="estilos_proyec.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        .register-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 70vh;
            padding: 20px;
        }
        
        .register-form {
            background-color: white;
            padding: 40px;
            border-radius: 12px;
            width: 100%;
            max-width: 500px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            border: 1px solid #e2e8f0;
        }
        
        .register-form h2 {
            color: #2c5282;
            text-align: center;
            margin-bottom: 30px;
            font-size: 24px;
        }
        
        .form-row {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .form-row .form-group {
            flex: 1;
        }
        
        .login-link {
            text-align: center;
            margin-top: 20px;
            color: #4a5568;
        }
        
        .login-link a {
            color: #4a90a4;
            text-decoration: none;
            font-weight: bold;
        }
        
        .login-link a:hover {
            text-decoration: underline;
        }
        
        .mensaje {
            padding: 12px;
            border-radius: 6px;
            margin: 15px 0;
            text-align: center;
            font-size: 14px;
        }
        
        .exito {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .password-requirements {
            font-size: 12px;
            color: #718096;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <div class="header-content">
                <div class="logo">UNICONNECT</div>
                <h1>Registro de Usuario</h1>
            </div>
        </div>
    </header>
    
    <nav>
        <ul>
            <li><a href="index.html">Inicio</a></li>
        </ul>
    </nav>
    
    <main class="container">
        <section class="register-container">
            <form class="register-form" id="registroForm">
                <h2>Crear Nueva Cuenta</h2>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="nombre">Nombre Completo:</label>
                        <input type="text" id="nombre" name="nombre" 
                               minlength="3" maxlength="100"
                               placeholder="Ej: Juan Pérez"
                               required>
                    </div>
                    
                    <div class="form-group">
                        <label for="username">Nombre de Usuario:</label>
                        <input type="text" id="username" name="username" 
                               pattern="[A-Za-z0-9]{3,20}"
                               placeholder="Ej: juanperez"
                               required>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="email">Correo Electrónico:</label>
                    <input type="email" id="email" name="email" 
                           placeholder="ejemplo@uniconnect.edu"
                           required>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="password">Contraseña:</label>
                        <input type="password" id="password" name="password" 
                               minlength="8"
                               placeholder="Mínimo 8 caracteres"
                               required>
                        <div class="password-requirements">
                            Debe contener al menos 8 caracteres
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="confirm_password">Confirmar Contraseña:</label>
                        <input type="password" id="confirm_password" name="confirm_password" 
                               minlength="8"
                               placeholder="Repite la contraseña"
                               required>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="tipo">Tipo de Usuario:</label>
                    <select id="tipo" name="tipo" required>
                        <option value="">Seleccione un tipo</option>
                        <option value="estudiante">Estudiante</option>
                        <option value="profesor">Profesor</option>
                    </select>
                </div>
                
                <div class="mensaje" id="mensaje" style="display: none;"></div>
                
                <button type="submit" class="btn" id="btnRegistrar">Registrar Cuenta</button>
                
                <div class="login-link">
                    ¿Ya tienes una cuenta? <a href="index.html">Inicia sesión aquí</a>
                </div>
            </form>
        </section>
    </main>
    
    <footer>
        <div class="container">
            <p>&copy; 2023 UNICONNECT - Todos los derechos reservados</p>
        </div>
    </footer>

<script type="module">
    import { supabase } from './supabaseClient.js';
    function validarContraseñas() {
        const password = document.getElementById('password').value;
        const confirmPassword = document.getElementById('confirm_password').value;
        
        if (password !== confirmPassword) {
            mostrarMensaje('Las contraseñas no coinciden', 'error');
            return false;
        }
        
        if (password.length < 8) {
            mostrarMensaje('La contraseña debe tener al menos 8 caracteres', 'error');
            return false;
        }
        
        return true;
    }
    
    function mostrarMensaje(texto, tipo) {
        const mensaje = document.getElementById('mensaje');
        mensaje.textContent = texto;
        mensaje.className = `mensaje ${tipo}`;
        mensaje.style.display = 'block';
        
        setTimeout(() => {
            mensaje.style.display = 'none';
        }, 5000);
    }
    
    async function handleRegistro(e) {
        e.preventDefault();
        
        if (!validarContraseñas()) {
            return;
        }
        
        const btnRegistrar = document.getElementById('btnRegistrar');
        const textoOriginal = btnRegistrar.textContent;
        
        btnRegistrar.disabled = true;
        btnRegistrar.textContent = 'Registrando...';
        
        const usuarioData = {
            username: document.getElementById('username').value,
            email: document.getElementById('email').value,
            password: document.getElementById('password').value,
            nombre_completo: document.getElementById('nombre').value,
            tipo: document.getElementById('tipo').value,
            activo: true
        };
        
        try {
            console.log('Intentando registrar:', usuarioData);
            
            // Verificar si el usuario ya existe
            const { data: usuarioExistente, error: errorBusqueda } = await supabase
                .from('usuarios_registro')
                .select('username, email')
                .or(`username.eq.${usuarioData.username},email.eq.${usuarioData.email}`);
            
            console.log('Resultado búsqueda:', usuarioExistente, errorBusqueda);
            
            if (errorBusqueda) {
                throw new Error('Error al verificar usuario existente: ' + errorBusqueda.message);
            }
            
            if (usuarioExistente && usuarioExistente.length > 0) {
                const usuario = usuarioExistente[0];
                if (usuario.username === usuarioData.username) {
                    throw new Error('El nombre de usuario ya está registrado');
                }
                if (usuario.email === usuarioData.email) {
                    throw new Error('El correo electrónico ya está registrado');
                }
            }
            
            // Insertar nuevo usuario
            const { data, error } = await supabase
                .from('usuarios_registro')
                .insert([usuarioData]);
            
            if (error) {
                console.error('Error Supabase:', error);
                throw new Error('Error al insertar: ' + error.message);
            }
            
            console.log('Registro exitoso:', data);
            mostrarMensaje('¡Cuenta creada exitosamente! Redirigiendo al login...', 'exito');
            
            setTimeout(() => {
                window.location.href = 'index.html';
            }, 2000);
            
        } catch (error) {
            console.error('Error completo:', error);
            mostrarMensaje(error.message || 'Error al registrar usuario', 'error');
            btnRegistrar.textContent = textoOriginal;
            btnRegistrar.disabled = false;
        }
    }
    
    function setupPasswordValidation() {
        document.getElementById('confirm_password').addEventListener('input', function() {
            const password = document.getElementById('password').value;
            const confirmPassword = this.value;
            
            if (password && confirmPassword && password !== confirmPassword) {
                this.style.borderColor = '#e53e3e';
            } else {
                this.style.borderColor = '#e2e8f0';
            }
        });
    }
    document.addEventListener('DOMContentLoaded', function() {
        const registroForm = document.getElementById('registroForm');
        if (registroForm) {
            registroForm.addEventListener('submit', handleRegistro);
            setupPasswordValidation();
            console.log('Formulario de registro inicializado');
        }
    });
</script>
</body>
</html>